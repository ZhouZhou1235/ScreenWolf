# 屏幕有狼主程序开发文档

屏幕有狼是一款基于 Java Swing 的桌面宠物游戏，玩家能在桌面上放置可交互的虚拟宠物。
游戏支持加载新宠物，每只宠物拥有独立的动画、数值和行为逻辑。


## 开发准备
语言：Java
JDK版本：OpenJDK-21
项目组织规范：Maven


## 运行原理
游戏主程序的启动器加载游戏，创建一个支持鼠标穿透的全屏透明窗体，启动器提供的窗口管理游戏进程。
玩家选择宠物加载到透明窗体中开始游玩。
窗体的实现依赖Java内置库 Swing 和 AWT。


## 项目结构
主程序即screenwolf文件夹，是一个Maven项目。
src/main/java下编写了游戏的源代码，Main.java为启动入口；
src/main/resources是主程序的资源。


## java类文档
下面给出开发宠物主要关注的java类说明

### Launcher 启动器
游戏的主启动器，负责初始化游戏环境、管理窗口和宠物列表。
Launcher()：构造函数，初始化文件目录、字体、透明屏幕、宠物列表等。
playGame()：开始游戏，将宠物添加到屏幕并显示。
stopGame()：停止游戏，清理宠物资源并隐藏屏幕。
reloadLauncher()：重新加载启动器，重置宠物列表和窗口。
addPetToLauncher(PetBase pet)：将宠物添加到启动器列表中。
testLoadPet(PetBase pet)：测试加载宠物（用于调试）。

### ItemBase 物品基类
所有可显示物品的基类，支持文本和图像显示，支持拖拽。
ItemBase(String text)：构造一个文本物品。
ItemBase(String name, ImageIcon icon)：构造图片物品。
setFontAdjustText(String text)：根据文本自动调整组件大小。
ready()：初始化鼠标事件，支持拖拽。

### PetBase 宠物基类
是所有桌面宠物的抽象基类。它定义了宠物的核心框架，包括动画播放、状态管理、用户交互（鼠标事件）、自主行为、好感度系统以及数据持久化。开发者应继承此类并实现特定宠物的逻辑。
---
#### 核心组件
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `animationSprite` | `AnimationSprite` | **动画精灵**，负责加载和播放宠物的序列帧动画。 |
| `launcher` | `Launcher` | **启动器引用**，用于与主游戏框架交互（如获取屏幕、添加组件）。 |
| `petOption` | `PetOption` | **宠物选项面板**，提供宠物的控制界面（如跟随、休息按钮）。 |
| `robot` | `Robot` | **自动化工具**，主要用于屏幕截图功能。 |
#### 数据与配置
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `petData` | `PetData` | **宠物静态数据**，从 `pet_data.json` 加载，包含名称、JAR包名、消息文本等。 |
| `playPetData` | `PlayPetData` | **宠物动态数据**，从保存文件加载，包含好感度、点击次数等游玩数据。 |
| `id` | `String` | 宠物唯一标识，默认为类名。 |
| `savePath` | `String` | 宠物数据保存的文件路径。 |
#### 状态标志
这些布尔值决定了宠物在任一时刻的行为和动画。
| 字段 | 说明 |
| :--- | :--- |
| `isFollow` | 为 `true` 时，宠物会跟随鼠标光标移动。 |
| `isFocus` | 为 `true` 时，鼠标正悬停在宠物上方。 |
| `isPress` | 为 `true` 时，鼠标正按在宠物身上（拖动中）。 |
| `isMoving` | 为 `true` 时，宠物正在移动（无论是自主移动还是跟随）。 |
| `isTouching` | 为 `true` 时，宠物正在被抚摸（通过滚轮事件触发）。 |
| `isResting` | 为 `true` 时，宠物正在休息，会播放休息动画并暂停大部分交互。 |
| `isAutoMoving` | 为 `true` 时，宠物正在自主移动到一个随机目标点。 |
| `isTargetAnimationPlaying` | 为 `true` 时，正在强制播放一个特定动画（如特殊或悲伤动画），会覆盖常规动画逻辑。 |
#### 行为阈值与计数器
这些值控制着宠物自主行为的触发频率和反应。
| 字段 | 说明 |
| :--- | :--- |
| `touchThreshold` | 抚摸值达到此阈值时，触发 `isTouching` 状态。 |
| `restThreshold` | 休息计数器达到此阈值时，宠物开始休息。 |
| `moveThreshold` | 移动计数器达到此阈值时，宠物开始自主移动。 |
| `emotionThreshold` | 情绪计数器达到此阈值时，宠物可能根据好感度播放特殊动画。 |
| `touchNum`, `restNum`, `moveNum`, `emotionNum` | 对应的计数器，在循环中递增。 |
| `inactiveCounter`, `dragCounter`等 | 其他行为计数器。 |
#### 数值属性
| 字段 | 说明 |
| :--- | :--- |
| `moveSpeed` | 宠物每次移动的像素距离。 |
| `followDistanse` | 开始跟随鼠标的距离阈值。 |
| `affectLevelUp` | 好感度每升一级所需的好感点数。 |
| `affectTopLevel` | 好感度的最高等级。 |
---
#### 生命周期
| 方法名 | 说明 |
| :--- | :--- |
| `PetBase(Launcher theLauncher)` | 构造函数，接收启动器实例并调用 `initPet()`。 |
| `initPet()` | **初始化核心流程**：<br>1. 设置大小和ID。<br>2. 从JAR包加载 `pet_data.json`。<br>3. 扫描动画资源并初始化 `AnimationSprite`。<br>4. 启动高速和低速循环计时器。<br>5. 调用 `ready()` 方法完成最终设置。 |
| `ready()` | 初始化完成的最终步骤，调用 `ready_loadPlay()` 和 `ready_addMouseAction()`。 |
| `ready_loadPlay()` | 加载或创建宠物的游玩数据 (`playPetData`) 并初始化选项面板 (`petOption`)。 |
| `ready_addMouseAction()` | 为宠物面板添加鼠标监听器。 |
| `dispose()` | **销毁宠物**：保存数据、停止计时器、移除动画、从父容器中移除自身并触发垃圾回收。 |

#### 循环与行为方法
| 方法名 | 调用频率 | 说明 |
| :--- | :--- | :--- |
| `autoLoop()` | **高速循环** (~60fps) | 每一帧执行，处理实时性高的任务：播放动画、跟随鼠标、自主移动、处理好感度增减。 |
| `slowAutoLoop()` | **低速循环** (~1fps) | 每秒执行一次，处理耗时或无需实时更新的任务：抚摸/休息状态更新、自主移动决策、好感度反应。 |
| `auto_playAnimations()` | (在 `autoLoop` 中) | **核心动画逻辑**：根据当前状态标志决定播放哪种动画。 |
| `auto_followMouse()` | (在 `autoLoop` 中) | 如果 `isFollow` 为真，计算与鼠标的距离，超过阈值则向鼠标移动。 |
| `gotoPoint(Point target)` | (被其他方法调用) | **移动逻辑**：计算朝向目标点的方向，并移动 `moveSpeed` 像素。同时根据X方向决定是否翻转精灵。 |
| `slowAuto_affectReact()` | (在 `slowAutoLoop` 中) | **好感度系统核心**：根据好感度等级调整宠物行为（如跟随距离）、触发特殊动画和消息。 |
#### 交互与命令方法
这些方法通常由用户输入或选项面板调用。
| 方法名 | 说明 |
| :--- | :--- |
| `followMouse()` | **切换跟随状态**。调用后会切换 `isFollow` 的状态。 |
| `doRest()` | **命令宠物休息**。调用后会清零计数器并设置 `isResting` 为 `true`。 |
| `showMessage(String message)` | 在宠物位置创建一个 `PetMessageBubble` 来显示消息。 |
| `readMessageList()` | 读取 `playPetData` 中的消息列表，并依次显示。 |
| `copyTextFromClipboard()` | 从系统剪贴板获取文本，分割后存入宠物的消息列表。 |
| `copyScreenImage()` | 使用 `Robot` 截取全屏，并将图像存入系统剪贴板。 |
| `playTargetAnimation(String name, int time)` | **强制播放指定动画**一段时间。在此期间 `isTargetAnimationPlaying` 为 `true`，会覆盖常规动画逻辑。 |
#### 数据与工具方法
| 方法名 | 说明 |
| :--- | :--- |
| `savePetData()` | 将 `playPetData` 对象序列化为JSON并保存到文件。 |
| `getPetPosition()` | 返回宠物面板中心的屏幕坐标。 |
| `isFree()` | 判断宠物当前是否处于“空闲”状态（没有任何交互或强制状态）。 |
| `zeroingResponseNum()` | **重置所有状态和计数器**。通常在开始一个新的交互时调用（如鼠标按下），用于中断当前行为（如休息、自主移动）。 |
| `addAffectPoint(int num)` | 增加好感点数，点数足够时升级好感度等级。 |
| `reduceAffectPoint(int num)` | 减少好感点数，点数不足时降级好感度等级。 |
#### 事件处理方法
这些 `protected` 方法处理鼠标事件，通常不需要直接调用，但可以在子类中重写以自定义行为。
| 方法名 | 触发事件 | 默认行为 |
| :--- | :--- | :--- |
| `handleMousePressed(MouseEvent e)` | 鼠标按下 | 左键：准备拖动；中键：读消息；右键：打开选项面板。 |
| `handleMouseWheelMoved(MouseWheelEvent e)` | 鼠标滚轮 | 增加 `touchNum`，模拟抚摸行为，增加好感度。 |
| `handleMouseDragged(MouseEvent e)` | 鼠标拖动 | 根据按下的点计算新位置，实现拖拽效果。 |
| `handleMouseClicked(MouseEvent e)` | 鼠标点击 | 左键点击：切换跟随状态。 |
---
#### 扩展
要创建一个新的宠物，请按以下步骤操作：
1.  **创建新类**：创建一个新类并继承 `PetBase`。
    ```java
    public class MyCustomPet extends PetBase {
        public MyCustomPet(Launcher launcher) {
            super(launcher);
        }
    }
    ```
2.  **准备资源**：在JAR包的 `assets/animations/` 目录下放置动画帧（如 `default/`, `move/`, `touch/` 等）。
3.  **准备配置文件**：在JAR包的 `META-INF/` 目录下提供 `pet_data.json` 文件，定义宠物元数据。
4.  **重写方法（可选）**：你可以重写任何方法来实现自定义行为。
5.  **添加到游戏**：将编译好的JAR包放入 `data/pets/` 目录，游戏启动时即可加载。
---
#### 状态机与动画优先级
宠物的行为是一个复杂的状态机。动画播放的优先级如下（从高到低）：
1.  `isTargetAnimationPlaying` (强制动画)
2.  `isResting` (休息动画)
3.  `isPress` (按压动画)
4.  `isMoving` / `isAutoMoving` (移动动画)
5.  `isFocus` + `isTouching` (抚摸动画)
6.  `isFocus` (聚焦动画)
7.  `default` (默认待机动画)

### AnimationSprite 动画精灵
负责播放宠物的序列帧动画
setAndPlayAnimation(String animationName)：设置并播放指定动画。
playAnimation()：开始播放动画。
stopAnimation()：停止播放动画。

### PetMessageBubble 宠物消息气泡
显示宠物发出的消息气泡，支持自动隐藏和鼠标交互。
PetMessageBubble(String text)：构造一个消息气泡。
setDisplayTime(int milliseconds)：设置显示时间。
adjustSizeToText(String text)：根据文本调整气泡大小。

### GUtil 全局工具
作为整个《屏幕有狼》项目的工具箱。它提供了大量静态方法，涵盖了文件操作、图像处理、UI辅助、数学计算、资源加载等常用功能，旨在减少代码重复并保持项目风格统一。
---
#### 静态常量/字段说明
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `GAME_maxFrameLength` | `int` | 动画最大帧数，防止数组越界。 |
| `GAME_renderTime` | `int` | 渲染计时器间隔（毫秒），约 31.25 FPS。 |
| `GAME_updateTime` | `int` | 高速循环（游戏逻辑）计时器间隔（毫秒），约 62.5 FPS。 |
| `GAME_slowUpdateTime` | `int` | 低速循环（非实时逻辑）计时器间隔（毫秒），约 1 FPS。 |
| `GAME_workPath` | `String` | 程序的工作目录绝对路径（`user.dir`）。 |
| `GAME_dataPath` | `String` | 游戏数据的总目录路径（`工作目录/data/`）。 |
| `GAME_savePath` | `String` | 宠物存档数据的保存路径（`工作目录/data/save/`）。 |
| `GAME_petsPath` | `String` | 宠物JAR包资源的存放路径（`工作目录/data/pets/`）。 |
| `SCREEN_dimension` | `Dimension` | 当前屏幕的尺寸（宽高）。 |
| `DEFAULT_animationPlaySpeed` | `int` | `AnimationSprite` 默认的帧切换间隔（毫秒）。 |
| `DEFAULT_windowSize` | `Dimension` | 程序默认窗口大小（屏幕宽高的一半）。 |
| `DEFAULT_textSize` | `int` | 根据屏幕宽度计算的默认字体大小。 |
| `DEFAULT_font` | `Font` | 程序的默认字体（DIALOG, PLAIN, 使用默认字体大小）。 |
| `DEFAULT_bodySize` | `Dimension` | 宠物图像的默认大小（屏幕宽度的 1/10）。 |
---
#### 文件与目录操作
| 方法签名 | 返回值 | 说明 |
| :--- | :--- | :--- |
| `static int createFile(String path)` | `int` | 创建文件。如果文件已存在返回 `0`，创建成功返回 `1`，失败打印异常。 |
| `static String readFile(String path)` | `String` | 读取指定文本文件的所有内容，以 UTF-8 编码返回字符串。失败返回空字符串。 |
| `static void saveToFile(String path, String content)` | `void` | 将字符串内容写入指定文件。如果文件不存在则创建。 |
| `static void initFileDirs()` | `void` | **初始化游戏文件目录结构**。确保 `data/`, `data/save/`, `data/pets/` 目录存在。 |
| `static String[] scanDir(String path)` | `String[]` | 列出指定目录下的所有文件和文件夹名称。 |
| `static String[] scanDir(String path, String extension)` | `String[]` | 列出指定目录下所有以 `extension` 结尾的文件名。 |
#### 图像处理与图标工具
| 方法签名 | 返回值 | 说明 |
| :--- | :--- | :--- |
| `static ImageIcon scaleImageIcon(ImageIcon icon, int l)` | `ImageIcon` | **等比例缩放图片**。根据给定的宽度 `l`，按原图宽高比计算高度并缩放。 |
| `static Image flipImage(Image image)` | `Image` | **水平翻转图像**。使用 `AffineTransformOp` 实现。 |
| `static ImageIcon createImageIconFromBytes(byte[] imageData)` | `ImageIcon` | 从字节数组（如从JAR中读取）创建 `ImageIcon`。 |
#### UI 与 Swing 辅助工具
| 方法签名 | 返回值 | 说明 |
| :--- | :--- | :--- |
| `static void initGlobalFont(Font font)` | `void` | **设置全局字体**。遍历 `UIManager` 的所有默认值，将字体统一设置为指定的 `FontUIResource`。 |
| `static void setWindowCenter(JFrame jFrame)` | `void` | 使一个 `JFrame` 在屏幕上居中显示。 |
| `static void clearTimerListeners(Timer timer)` | `void` | 清除 `javax.swing.Timer` 上的所有 `ActionListener`。 |
| `static JButton createIconButton(String path, String tooltip, int size)` | `JButton` | **创建一个图标按钮**。从主程序资源路径加载图标，缩放，并设置无边框、手型光标等样式。 |
| `static JButton createIconButton(ImageIcon icon, String tooltip, int size)` | `JButton` | **创建一个图标按钮**。直接使用提供的 `ImageIcon`，其他样式同上。 |
#### 数学与计算工具
| 方法签名 | 返回值 | 说明 |
| :--- | :--- | :--- |
| `static Point getMousePoint()` | `Point` | 获取鼠标光标在当前屏幕上的坐标。 |
| `static double getDistanse2Point(Point point1, Point point2)` | `double` | 计算屏幕上两点之间的欧几里得距离。 |
| `static Point getRandomPointOnScreen()` | `Point` | 在屏幕范围内随机生成一个点的坐标。 |
#### 资源与反射工具
| 方法签名 | 返回值 | 说明 |
| :--- | :--- | :--- |
| `static Object loadObjFromJarByClass(String jarPath, String jarClass, Object... constructorArgs)` | `Object` | **从JAR包中动态加载类并实例化**。用于加载宠物类。参数 `constructorArgs` 是构造函数的实参。 |
| `static String[] splitTextIntoMessages(String text)` | `String[]` | **长文本分割算法**。根据中英文标点符号和长度（约50字符）将长文本分割成适合消息气泡显示的字符串数组。 |
| `static int copyFilesWithDialog(Component parent, String dialogTitle, String fileTypeDesc, String fileExtension, String destDir)` | `int` | **显示文件选择对话框并复制文件**。功能强大，支持多选、文件类型过滤、覆盖确认、成功/失败提示。返回成功复制的文件数。 |


### JarFileUtil jar包文件工具类
用于从JAR包中读取资源文件
listJarDirNamesByPath(String jarPath, String dirPath)：列出JAR中指定目录下的文件夹名。
listJarFileMapByPath(String jarPath, String dirPath)：读取JAR中指定目录下的文件内容（字节数组）。
readByteInJarFile(String jarPath, String filePath)：读取JAR中指定文件的字节流。

### PetOption 宠物选项面板
每只宠物的专属控制面板，显示状态和提供交互按钮。
PetOption(PetBase pet)：构造函数，初始化面板。
loadButtonsToPanel()：加载按钮到面板。
updateStatusText()：更新宠物状态文本。
showWindow()：显示面板。
closeWindow()：关闭面板。
